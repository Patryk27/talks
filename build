#!/usr/bin/env bash

set -e

function build-one {
    PRESENTATION=$1

    echo "[+] Building \`$PRESENTATION\`"

    podman run \
        --rm \
        -v "$(pwd)/$PRESENTATION:/mnt/src:ro" \
        -v "$(pwd)/_assets:/mnt/_assets" \
        -u `id -u $USER` \
        asciidoctor-pdf \
            ./presentation.adoc \
            --template-require ./template.js \
            -r asciidoctor-kroki

    # HTML files generated by `asciidoctor-pdf.js` contain references to `/mnt`,
    # which we have to get rid ofm if we want the HTMLs to be actually usable
    sed -i 's/\/mnt\///g' "$PRESENTATION/presentation.html"

    mkdir "out"
    mv "$PRESENTATION/presentation.html" "out/$PRESENTATION.html"
    mv "$PRESENTATION/presentation.pdf" "out/$PRESENTATION.pdf"
}

function build-all {
    podman build -t asciidoctor-pdf ./_deps/asciidoctor-pdf

    build-one 2020-fantastic-actors
    build-one 2020-scary-acronyms
}

if [[ -z "$1" ]]; then
    build-all
else
    build-one "$1"
fi
