#!/usr/bin/env bash

set -e

if [[ -z "$1" ]]; then
    echo "Usage:"
    echo "  ./build <talk-name>"
    exit 0
fi

TALK=$1

podman run \
    --rm \
    -v "./_common:/mnt/common:ro" \
    -v "./$TALK/talk:/mnt/src:rw" \
    asciidoctor-pdf \
        --template-require /mnt/src/template.js \
        --require asciidoctor-kroki \
        --failure-level warning \
        /mnt/src/talk.adoc

mv "$TALK/talk/talk.pdf" "$TALK/talk/output.pdf"
mv "$TALK/talk/talk.html" "$TALK/talk/output.html"

# HTML files generated by `asciidoctor-pdf.js` contain references to `/mnt`,
# which we have to get rid of, if we want the HTMLs to be actually usable
sed -i 's/\/mnt\/common/..\/..\/_common/g' "$TALK/talk/output.html"
