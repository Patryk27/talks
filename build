#!/usr/bin/env bash

set -e

function build-one {
    PRESENTATION=$1

    echo "[+] Building \`$PRESENTATION\`"

    podman run \
        --rm \
        -v "./_common:/mnt/common:ro" \
        -v "./$PRESENTATION:/mnt/src:rw" \
        asciidoctor-pdf \
            --template-require /mnt/src/template.js \
            --require asciidoctor-kroki \
            --failure-level warning \
            /mnt/src/talk.adoc

    # HTML files generated by `asciidoctor-pdf.js` contain references to `/mnt`,
    # which we have to get rid of, if we want the HTMLs to be actually usable
    sed -i 's/\/mnt\/common/..\/_common/g' "$PRESENTATION/talk.html"
}

function build-all {
    podman build -t asciidoctor-pdf ./_deps/asciidoctor-pdf

    build-one 2020-cant-hack-this
    build-one 2020-fantastic-actors
    build-one 2020-scary-acronyms
}

if [[ -z "$1" ]]; then
    build-all
else
    build-one "$1"
fi
